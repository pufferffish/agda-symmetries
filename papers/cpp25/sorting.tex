% !TEX root = cpp25-sort.tex

\section{Total orders and Sorting}
\label{sec:sorting}

Since the free commutative monoid is also a monoid, there is a canonical map (monoid homomorphism)
$q : \LL(A) \to \MM(A)$, which is given by $\ext{\eta_A}$.
%
Since $\MM(A)$ is (equivalently), a quotient of $\LL(A)$ by the commutativity (or permutation) relation,
it is a surjection (an effective epimorphism in $\Set$, as constructed in type theory).
%
Concretely, $q$ simply includes the elements of $\LL(A)$ into equivalence classes of lists in $\MM(A)$,
which is forgetting the order (that was imposed by the list).
% function which "forgets" the order on a free monoid and turns it into a free commutative monoid.

The classical principle of Axiom of Choice says every that surjection $f$ has a section (right-inverse) $s$, that is:
$\forall x.\, f(s(x)) = x$. Or in informal terms, given a surjection which includes into a quotient, a section
(uniformly) picks out a canonical representative for each equivalence class.
%
\textbf{Puzzle:} In our construction, does $q$ have a section? If symmetry kills the order, can it be resurrected?

\begin{figure}[H]
    \centering
    \scalebox{1.3}{
        % https://q.uiver.app/#q=WzAsMixbMCwwLCJcXExMKEEpIl0sWzMsMCwiXFxNTShBKSJdLFsxLDAsInMiLDAseyJjdXJ2ZSI6LTF9XSxbMCwxLCJxIiwwLHsiY3VydmUiOi0xfV1d
        \begin{tikzcd}[ampersand replacement=\&,cramped]
            {\LL(A)} \&\&\& {\MM(A)}
            \arrow["s", curve={height=-10pt}, from=1-4, to=1-1]
            \arrow["q", two heads, from=1-1, to=1-4]
        \end{tikzcd}
    }
    \caption{Relationship of $\LL(A)$ and $\MM(A)$}
    \label{fig:enter-label}
\end{figure}

Since the quotienting relation is a permutation relation (from~\cref{cmon:qfreemon}), a section $s$ to $q$ would pick a
canonical representative out of the equivalence class generated by permutation.
%
Using $\SList$ as an example, $s(x \cons y \cons xs) = s(y \cons x \cons xs)$ for any $x, y : A$ and $xs : \SList(A)$,
and since it must also respect $\forall xs.\,q(s(xs)) = xs$, $s$ must preserve all the elements of $xs$.
It cannot be a trivial function such as $\lambda\,xs. []$ -- it must produce a permutation of the elements of $s$!
%
But to place these elements side-by-side in the list, $s$ must somehow impose an order on $A$
(invariant under permutation), turning unordered lists of $A$ into ordered lists of $A$.
%
Axiom of Choice (AC) giving us a section $s$ to $q$ ``for free'' is analagous to how
AC implies the well-ordering principle, which states every set can be well-ordered.
%
If we assumed AC our problem would be trivial!
%
Instead we study how to constructively define such a section, and in fact, that is exactly a sorting algorithm,
and the implications of its existence is that $A$ can be ordered, or sorted.

We now study sort functions as sections and their relationship with total orders.
First, we recall the axioms of a total order $\leq$ on a set $A$:
\begin{itemize}
    \item reflexivity: $x \leq x$
    \item transitivity: if $x \leq y$ and $y \leq z$, then $x \leq z$
    \item antisymmetry: if $x \leq y$ and $y \leq x$, then $x = y$
    \item totality: forall $x$ and $y$, we have \emph{merely} either $x \leq y$ or $y \leq x$
\end{itemize}

In the context of this paper, we also want to make a distinction between ``decidable total order''
and just ``total order''. A decidable total order should also satisfy
\begin{itemize}
    \item decidability: forall $x$ and $y$, we have either $x \leq y$ or $\neg(x \leq y)$
\end{itemize}

This is a stronger version of the totality axiom, where with totality we have
either $x \leq y$ or $y \leq x$ merely as a proposition, but decidability allows us to actually
compute if $x \leq y$ is true. Given this assumption on $A$, we can sort!

\subsection{Section from Order}

\begin{proposition}
    Assume there is a decidable total order on $A$. There is a sort function $s: \MM(A) \to \LL(A)$
    which constructs a section to $q : \LL(A) \twoheadrightarrow \MM(A)$
\end{proposition}

\begin{proof}
    We can construct such a section by any sorting algorithm. In our formalization we chose
    insertion sort $\SList(A) \to \List(A)$ due to its inductive properties and simple definition.
    However, if we want to define other sorting algorithms, eÂ .g. merge-sort,
    other representations such as $\Bag \to \Array$ would be more suitable as we have explained in~\cref{bag:rep}.
    It is easy to see how this
    proposition holds: $q(s(xs))$ orders an unordered list $xs$ by $s$, and re-discards the order again by
    $q$, the act of imposing and then forgetting an order on $xs$ simply \emph{permutes} the elements of $xs$,
    which is the proof of $q(s(xs)) = xs$.
\end{proof}

\subsection{Order from Section}

The previous section allowed us to construct a section -- how do we know this is a \emph{correct} sort function?
%
At this point we ask: if we can construct a section from order, can we construct an order from section?
%
Indeed, just by the virtue of $s$ being a section, we can almost construct a relation that satisfies
all axioms of total order, except transitivity!
We use $\{x,y,\dots\}$ to denote $\eta_A(x) \mult \eta_A(y) \mult \dots : \MM(A)$,
and $[x, y, \dots]$ to denote $\eta_A(x) \mult \eta_A(y) \mult \dots : \LL(A)$,
or $x \cons xs$ to denote $\eta_A(x) \mult xs : \LL(A)$.

\begin{definition}
    \label{def:least}
    Given a section $s$, we define:
    \[
        \begin{aligned}
            \term{least}(xs) & := \term{head}(s(xs))                    \\
            x \preccurlyeq y & := \term{least}(\{x, y\}) = x \enspace .
        \end{aligned}
    \]
\end{definition}

Conceptually, $\term{least}$ sorts $xs$ by $s$, and picks the first element of the sorted list by~$\term{head}$.
This is the main insight, using which we establish our result.
First, we observe some properties of $\preccurlyeq$.

\begin{proposition}
    $\preccurlyeq$ is decidable iff $A$ has decidable equality.
\end{proposition}

\begin{proposition}\label{sort:almost-total}
    $\preccurlyeq$ is reflexive, antisymmetric, and total.
\end{proposition}
\begin{proof}
    For all $x$, $\term{least}(\{x, x\})$ must be $x$, therefore $x \preccurlyeq x$, giving reflexivity.
    For all $x$ and $y$, given $x \preccurlyeq y$ and $y \preccurlyeq x$,
    we have $\term{least}(\{x, y\}) = x$ and $\term{least}(\{y, x\}) = y$.
    Since $\{x, y\} = \{y, x\}$, $\term{least}(\{x, y\}) = \term{least}(\{y, x\})$,
    therefore we have $x = y$, giving antisymmetry.
    For all $x$ and $y$, $\term{least}(\{x, y\})$ is merely either $x$ or $y$,
    therefore we have merely either $x \preccurlyeq y$ or $y \preccurlyeq x$, giving totality.
\end{proof}

\begin{proposition}
    $\preccurlyeq$ is not necessarily transitive.
\end{proposition}
\begin{proof}
    We give a counter-example of $s$ that would violate transitivity.
    Consider this section $s : \SList(\Nat) \to \List(\Nat)$, we can define a sort function
    $\term{sort} : \SList(\Nat) \to \List(\Nat)$ which sorts $\SList(\Nat)$ ascendingly. We can use $\term{sort}$
    to construct $s$.
    \begin{align*}
        s(xs)        & = \begin{cases}
                             \term{sort}(xs)                 & \text{if $\term{length}(xs)$ is odd} \\
                             \term{reverse}(\term{sort}(xs)) & \text{otherwise}
                         \end{cases} \\
        s([2,3,1,4]) & = [4,3,2,1]                                                                     \\
        s([2,3,1])   & = [1,2,3]
    \end{align*}
\end{proof}
As we can see, we need more constraints on $s$ to prove $\preccurlyeq$ is transitive.
These constraints lead to the axioms of sorting!
\begin{definition}
    Given a list $xs : \LL(A)$, we say $xs$ is in the image of s $\issorted(xs)$ if there \emph{merely exists}
    a $ys : \MM(A)$ such that $s(ys) = xs$.
\end{definition}

If $s$ were a sort function, the image of $s$ would be the set of sorted lists, therefore
$\issorted(xs)$ would imply $xs$ is a sorted (or ordered) list.

\begin{proposition}\label{sort:sort-to-order}
    $x \preccurlyeq y$ \; iff \; $\issorted([x, y])$.
\end{proposition}

\noindent
To prevent this class of counter-examples, we now introduce our first axiom of sorting:
\begin{definition}\label{sort:head-least}
    A section $s$ to $q$ satisfies $\isheadleast$ iff:
    \[
        \forall x\, y\, xs.\, \issorted(x \cons xs) \land y \in (x \cons xs) \to \issorted([x,y])
        \enspace .
    \]
\end{definition}
Here we use the definition of $\in$ from~\cref{comb:member}. Informally,
if $s$ were a sort function, this states if
$x$ is the smallest element of a sorted list $ys$, then for any element $y \in ys$,
$[x, y]$ should be also a sorted list.
%
This ensures that $s$ behaves correctly on 2-element lists.

\begin{proposition}
    If $A$ has a total order $\leq$, insertion sort $\MM(A) \to \LL(A)$ defined with $\leq$
    satisfies $\isheadleast$.
\end{proposition}

\begin{proposition}\label{sort:trans}
    Assuming $s$ satisfies $\isheadleast$, $\preccurlyeq$ is transitive.
\end{proposition}
\begin{proof}
    We use a weaker version of the axiom where $x \cons xs$ is fixed to have length of 3.
    We are given $x \preccurlyeq y$ and $y \preccurlyeq z$, we want to show $x \preccurlyeq z$.
    Consider the 3-element $\{x,y,z\} : \MM(A)$. Let $u$ be $\term{least}(\{x,y,z\})$,
    by~\cref{sort:head-least} and~\cref{sort:sort-to-order},
    we have $u \preccurlyeq x \land u \preccurlyeq y \land u \preccurlyeq z$.
    Since $u \in \{x,y,z\}$, $u$ must be one of the element. We prove transitivity by case splitting.
    If $u = x$ we have $x \preccurlyeq z$. If $u = y$ we have $y \preccurlyeq x$, and since
    $x \preccurlyeq y$ and $y \preccurlyeq z$ by assumption,
    we have $x = y$ by antisymmetry and then we have $x \preccurlyeq z$ by substitution.
    Finally, if $u = z$, we have $z \preccurlyeq y$, and since
    $y \preccurlyeq z$ and $x \preccurlyeq y$ by assumption,
    we have $z = y$ by antisymmetry and then we have $x \preccurlyeq z$ by substitution.
\end{proof}

\subsection{Embedding orders into sections}

We have shown that a section $s$ that satisfies $\isheadleast$ would imply a total order
$x \preccurlyeq y := \term{least}(\{x, y\}) = x$,
and a total order $\leq$ would imply a section that satisfies $\isheadleast$ which can
be constructed by insertion sort with $\leq$. Now, can we construct a full equivalence
between sections $\MM(A) \to \LL(A)$ that satisfy $\isheadleast$ and total orders on $A$?

\begin{proposition}\label{sort:o2s2o}
    Assume $A$ has a decidable total order $\leq$, we can construct a section $s$ that
    satisfies $\isheadleast$, such that $\preccurlyeq$ constructed from $s$ is equivalent
    to $\leq$.
\end{proposition}

\begin{proof}
    We define our section $s : \MM(A) \to \LL(A)$ satisfying $\isheadleast$ to be
    insertion sort defined on $A$ by $\leq$.
    It is trivial to see $\issortedany_{\term{s}}([x, y])$ iff $x \leq y$ by the definition
    of insertion sort. By~\cref{sort:sort-to-order} we can see $x \preccurlyeq y$ iff $x \leq y$.
    We now have a total order $x \preccurlyeq y$ equivalent to $x \leq y$.
\end{proof}

We now have one side of the isomorphism, and showed the set of decidable total order of $A$
can be embedded into the set of sections $s$ that satisfy $\isheadleast$.

\subsection{Equivalence of order and sections}
To upgrade the embedding to an isomorphism, all that is left
is to show we can turn a section satisfying $\isheadleast$ to a total order $\preccurlyeq$, and construct the
same section back from $\preccurlyeq$. Unfortunately, this fails!

\begin{proposition}
    Assume $A$ is a set with different elements, i.e. $\exists x, y: A.\,x \neq y$,
    we cannot construct a full equivalence between sections that satisfy $\isheadleast$
    and total orders on $A$.
\end{proposition}

\begin{proof}
    We give a counter-example of $s$ that satisfy $\isheadleast$ but is not a sort function.
    Consider the insertion sort function $\term{sort} : \MM(\Nat) \to \LL(\Nat)$
    parameterized by $\leq$:
    \begin{align*}
        \term{reverseTail}([])         & = []                                  \\
        \term{reverseTail}(x \cons xs) & = x \cons \term{reverse}(xs)          \\
        s(xs)                          & = \term{reverseTail}(\term{sort}(xs)) \\
        s(\{2,3,1,4\})                 & = [1,4,3,2]                           \\
        s(\{2,3,1\})                   & = [1, 3, 2]                           \\
        s(\{2,3\})                     & = [2, 3]                              \\
    \end{align*}
    By~\cref{sort:o2s2o} we can use $\term{sort}$ to construct $\preccurlyeq$ which would be
    equivalent to $\leq$. However, the $\preccurlyeq$ constructed by $s$ would also be equivalent
    to $\leq$. This is because $s$ sorts 2-element list correctly, despite $s \neq \term{sort}$.
    Since two different sections satisfying $\isheadleast$ maps to the same total order,
    there cannot be a full equivalence.
\end{proof}

As we can see, we need more constraints to prove a full equivalence.
We introduce our second axiom of sorting:
\begin{definition}
    A section $s$ to $q$ satisfies $\istailsort$ iff
    $\forall x\,xs.\,\issorted(x \cons xs) \to \issorted(xs)$.
\end{definition}

To prove that this axiom is correct, we need to show a section $s$ satisfying
$\isheadleast$ and $\istailsort$ would be equal to insertion sort parameterized by
the $\preccurlyeq$ constructed from $s$. To prove this, we introduce an inductive data type
for a witness of sorted lists, taken from~\cite{appelVerifiedFunctionalAlgorithms2023}.

\begin{code}
data Sorted ($\leq$ : A -> A -> UU) : List A -> UU where
  sorted-nil : Sorted []
  sorted-one : forall x -> Sorted [ x ]
  sorted-cons : forall x y zs -> x $\leq$ y
     -> Sorted (y cons zs) -> Sorted (x cons y cons zs)
\end{code}

\begin{proposition}
    Given an order $\leq$, for any $xs, ys : \LL(A)$,
    $q(xs) = q(ys) \land \term{Sorted}_{\leq}(xs) \land \term{Sorted}_{\leq}(ys) \to xs = ys$.
\end{proposition}

Informally, this states if $xs$ and $ys$ have the same elements, i.e. they belong to the same
equivalence class generated by permutations, and if they are both sorted by $\leq$, then they would be the same.

\begin{corollary}\label{sort:sort-uniq}
    Given an order $\leq$,
    if a section $s$ always produces sorted list, i.e. $\forall xs.\,\term{Sorted}_{\leq}(s(xs))$,
    $s$ is equal to insertion sort by $\leq$.
\end{corollary}
It is trivial to see how insertion sort by $\leq$ would always produce lists that satisfy
$\term{Sorted}_{\leq}$. Therefore, any functions that also always produce lists that satisfy
$\term{Sorted}_{\leq}$ would equal to insertion sort by function extensionality.

\begin{corollary}\label{sort:well-behave-sorts}
    Given a section $s$ that satisfies $\isheadleast$ and $\istailsort$,
    let $\preccurlyeq$ be the order derived from $s$,
    $\forall xs.\,\term{Sorted}_{\preccurlyeq}(s(xs))$.
\end{corollary}
\begin{proof}
    For lists of length 0 and 1 this is trivial. For further cases we need to prove by induction:
    given a $xs : \MM(A)$ of length $\geq 2$, let $s(xs) = x \cons y \cons ys$. We need to show
    $x \preccurlyeq y \land \term{Sorted}_{\preccurlyeq}(y \cons ys)$ to construct
    $\term{Sorted}_{\preccurlyeq}(x \cons y \cons ys)$.
    By $\isheadleast$ we have $x \preccurlyeq y$, and by $\istailsort$ we can prove
    inductively $\term{Sorted}_{\preccurlyeq}(y \cons ys)$.
\end{proof}

We can now prove the full equivalence:
\begin{proposition}\label{sort:s2o2s}
    Assume $A$ has a decidable total order $\leq$, then we can construct
    a section $t_\leq$ that satisfies $\isheadleast$ and $\istailsort$,
    such that if the order $\preccurlyeq$ is derived from such a section $s$,
    $t_\preccurlyeq = s$.
\end{proposition}
\begin{proof}
    From $s$ we can construct a decidable total order $\preccurlyeq$ since $s$ satisfies
    $\isheadleast$ and $A$ has decidable equality by assumption.
    We construct $t_\preccurlyeq$ as insertion sort
    parameterized by $\preccurlyeq$ constructed from $s$.
    By ~\cref{sort:sort-uniq} and ~\cref{sort:well-behave-sorts}, $s = t_\preccurlyeq$.
\end{proof}

\begin{proposition}\label{sort:decord-to-deceq}
    Assume $A$ has a decidable total order $\leq$,
    then $A$ has decidable equality.
\end{proposition}
\begin{proof}
    Since $\leq$ is decidable, we can use it to show $A$ has decidable equality as follow:
    We decide if $x \leq y$ and $y \leq x$ and perform case splitting:
    \begin{itemize}
        \item
              Case $x \leq y$ and $y \leq x$: by antisymmetry, $x = y$.
        \item
              Case $\neg(x \leq y)$ and $y \leq x$: if $x = y$, then $x \leq y$,
              leading to contradiction by $\neg(x \leq y)$. Therefore $x \neq y$.
        \item
              Case $x \leq y$ and $\neg(y \leq x)$: Similar logic as above.
        \item
              Case $\neg(x \leq y)$ and $\neg(y \leq x)$: by totality we must have either
              $x \leq y$ or $y \leq x$, therefore contradiction, this case would never occur.
    \end{itemize}
\end{proof}

We can now state our main theorem: a well-behaved section $s : \MM(A) \to \LL(A)$ to
the canonical map $q : \LL(A) \to \MM(A)$ should satisfy the following two axioms,
which axiomatizes a correct sorting algorithm.
\begin{definition}
    \leavevmode
    \begin{itemize}[leftmargin=*]
        \item $\isheadleast$: any 2-element list can be correctly sorted\\
              \(
              \forall x \: y \: xs. \issorted(x \cons xs) \land y \in (x \cons xs) \to \issorted(x \cons y \cons [])
              \),
        \item $\istailsort$: the first axiom can be coherently lifted to 2+-element list\\
              \(
              \forall x \: xs. \issorted(x \cons xs) \to \issorted(xs)
              \).
    \end{itemize}
\end{definition}
\begin{theorem}\label{sort:main}
    Let $\term{DecTotOrd}(A)$ be the set of decidable total orders on $A$,
    $\term{Sort}(A)$ be the set of correct sorting functions with carrier set $A$,
    and $\term{isDiscrete}(A)$ be a predicate which states $A$ has decidable equality.
    We have the function $o2s \colon \term{DecTotOrd}(A) \to \term{Sort}(A) \times \term{isDiscrete}(A)$
    is an equivalence.
\end{theorem}
\begin{proof}
    $o2s(\leq)$ can be constructed by parameterizing insertion sort with $\leq$.
    By~\cref{sort:decord-to-deceq} we show that $A$ satisfy $\term{isDiscrete}$.
    The inverse $s2o(s)$ can be constructed by~\cref{def:least}, which is proven to be
    a total order by~\cref{sort:almost-total} and~\cref{sort:trans}, and decidable
    since we assume $\term{isDiscrete}(A)$.

    By~\cref{sort:o2s2o} we show that $s2o \comp o2s = id$, and by~\cref{sort:s2o2s}
    we show that $o2s \comp s2o = id$, therefore we have a full equivalence.
\end{proof}

\subsubsection*{Remarks}

The sorting axioms we have come up with are abstract properties of functions.
%
As a sanity check, we can verify that the colloquial correctness specification of a sorting function (starting from a
total order) matches our axioms.
%
\begin{proposition}
    \label{prop:sort-correctness}
    Assume a totally ordered set $A$.
    %
    A sorting algorithm is a function $\term{sort} : \LL(A) \to \type{O}\LL(A)$,
    that turns lists into ordered lists,
    where $\type{O}\LL(A)$ is $\dsum{xs : \LL(A)}{\term{Sorted}_{\leq}(xs)}$,
    such that:
    % https://q.uiver.app/#q=WzAsMyxbMCwwLCJcXExMKEEpIl0sWzIsMCwiXFx0eXBle099XFxMTChBKSJdLFsxLDEsIlxcTU0oQSkiXSxbMCwxLCJcXHRlcm17c29ydH0iXSxbMCwyLCJxIiwyXSxbMSwyLCJxIFxcY29tcCBcXHBpXzEiXV0=
    \[\begin{tikzcd}[ampersand replacement=\&,cramped]
            {\LL(A)} \&\& {\type{O}\LL(A)} \\
            \& {\MM(A)}
            \arrow["{\term{sort}}", from=1-1, to=1-3]
            \arrow["q"', from=1-1, to=2-2]
            \arrow["{q \comp \pi_1}", from=1-3, to=2-2]
        \end{tikzcd}\]
\end{proposition}
\begin{proofsketch}
    Using our section $s$,
    we have $p : \forall xs.\,\term{Sorted}_{\preccurlyeq}(s(xs))$ by~\cref{sort:well-behave-sorts}.
    We set $\term{sort} = (s \comp q ,\,p \comp q)$, and the rest follows by calculation.
\end{proofsketch}